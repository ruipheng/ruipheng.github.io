<!DOCTYPE html ><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>浏览器跨域问题的总结</title></head><body><p></p><p class="edui-filter-align-center"><span>浏览器跨域问题的总结</span></p><p class="edui-filter-align-left"><span>目录</span></p><p><span> </span></p><p><span>1.document.domain+iframe</span><span>情形</span><span>2</span></p><p><span>2.jQuery</span><span>下通过</span><span>jsonp</span><span>实现跨域</span><span>3</span></p><p><span>3.</span><span>服务器端的跨域解决方案</span><span>4</span></p><p><span>4.IE8</span><span>下的跨域问题</span><span>13</span></p><p><br /></p><p><span> </span></p><p><span><br /></span></p><p class="edui-filter-align-center"><span> </span></p><p><span>JavaScript出于安全方面的考虑，不允许跨域调用其他页面的对象。但在安全限制的同时也给注入iframe或是ajax应用上带来了不少麻烦。我们在项目开发中遇到了几种跨域情形，现在进行一些总结，也对互联网上凌乱的东西进行一些总结,着重描述上述一些情景，以下列举跨域问题的几种情形</span></p><p><span> </span></p><p><span>URL</span></p><p><span>说明</span></p><p><span>是否允许通信</span></p><p><span>http://www.a.com/a.js</span><span><br /></span><span><a href="http://www.a.com/b.js">http://www.a.com/b.js</a></span></p><p><span>同一域名下</span></p><p><span>允许</span></p><p><span>http://www.a.com/lab/a.js</span><span><br /></span><span>http://www.a.com/script/b.js</span></p><p><span>同一域名下不同文件夹</span></p><p><span>允许</span></p><p><span>http://www.a.com:8000/a.js</span><span><br /></span><span><a href="http://www.a.com/b.js">http://www.a.com/b.js</a></span></p><p><span>同一域名，不同端口</span></p><p><span>不允许</span></p><p><span>http://www.a.com/a.js</span><span><br /></span><span><a href="https://www.a.com/b.js">https://www.a.com/b.js</a></span></p><p><span>同一域名，不同协议</span></p><p><span>不允许</span></p><p><span>http://www.a.com/a.js</span><span><br /></span><span><a href="http://70.32.92.74/b.js">http://70.32.92.74/b.js</a></span></p><p><span>域名和域名对应ip</span></p><p><span>不允许</span></p><p><span>http://www.a.com/a.js</span><span><br /></span><span><a href="http://script.a.com/b.js">http://script.a.com/b.js</a></span></p><p><span>主域相同，子域不同</span></p><p><span>不允许</span></p><p><span>http://www.a.com/a.js</span><span><br /></span><span><a href="http://a.com/b.js">http://a.com/b.js</a></span></p><p><span>同一域名，不同二级域名（同上）</span></p><p><span>不允许（cookie这种情况下也不允许访问）</span></p><p><span>http://www.cnblogs.com/a.js</span><span><br /></span><span><a href="http://www.a.com/b.js">http://www.a.com/b.js</a></span></p><p><span>不同域名</span></p><p><span>不允许</span></p><p><span>特别注意两点：</span></p><p><span>第一，如果是协议和端口造成的跨域问题“前台”是无能为力的，</span></p><p><span>第二：在跨域问题上，域仅仅是通过“URL的首部”来识别而不会去尝试判断相同的ip地址对应着两个域或两个域是否在同一个ip上。</span><span><br /></span><span>“URL的首部”指window.location.protocol +window.location.host，也可以理解为“Domains, protocols and ports must match”。</span></p><p><span> </span></p><h1><span>1</span><span>.</span><span>document.domain+iframe</span><span>情形</span></h1><p><span>对于主域相同而子域不同的例子，可以通过设置document.domain的办法来解决。具体的做法是可以在http://www.a.com/a.html和http://script.a.com/b.html两个文件中分别加上document.domain = ‘a.com’；然后通过a.html文件中创建一个iframe，去控制iframe的contentDocument，这样两个js文件之间就可以“交互”了。当然这种办法只能解决主域相同而二级域名不同的情况，如果你异想天开的把script.a.com的domian设为alibaba.com那显然是会报错地！代码如下：</span></p><p><span>www.a.com上的a.html</span></p><p><span>document.domain = 'a.com';</span></p><p><span>var ifr = document.createElement('iframe');</span></p><p><span>ifr.src = 'http://script.a.com/b.html';</span></p><p><span>ifr.style.display = 'none';</span></p><p><span>document.body.appendChild(ifr);</span></p><p><span>ifr.onload = function(){</span></p><p><span> &nbsp;&nbsp;&nbsp;var doc = ifr.contentDocument || ifr.contentWindow.document;</span></p><p><span> &nbsp;&nbsp;&nbsp;// 在这里操纵b.html</span></p><p><span> &nbsp;&nbsp;&nbsp;alert(doc.getElementsByTagName(&quot;h1&quot;)[0].childNodes[0].nodeValue);</span></p><p><span>};</span></p><p><span>script.a.com上的b.html</span></p><p><span>document.domain = 'a.com';</span></p><p><span>这种方式适用于{www.kuqin.com, kuqin.com, script.kuqin.com, css.kuqin.com}中的任何页面相互通信。</span></p><p><span> </span></p><p><span>备注：</span></p><p><span>某一页面的domain默认等于window.location.hostname。主域名是不带www的域名，例如a.com，主域名前面带前缀的通常都为二级域名或多级域名，例如www.a.com其实是二级域名。 domain只能设置为主域名，不可以在b.a.com中将domain设置为c.a.com。</span></p><p><span>问题：</span></p><p><span>1、安全性，当一个站点（b.a.com）被攻击后，另一个站点（c.a.com）会引起安全漏洞。</span></p><p><span>2、如果一个页面中引入多个iframe，要想能够操作所有iframe，必须都得设置相同domain。</span><span>我们工行商城IM联调过程中尝试过这种方式，最终因为影响页面其他iframe的功能而放弃。最终我们调整了融e购的IM前端结构.</span></p><p><span> </span></p><h1><span>2.jQuery<span>下通过</span><span>jsonp</span><span>实现跨域</span></span></h1><p><span>JSONP是一个非官方的协议，它允许在服务器端集成Script tags返回至客户端，通过javascript callback的形式实现跨域访问（这仅仅是JSONP简单的实现形式）。JSON系统开发方法是一种典型的面向数据结构的分析和设计方法，以活动为中心，一连串的活动的顺序组合成一个完整的工作进程。</span></p><p><span>$.getJSON(url+&quot;?callback=?&quot;, &nbsp;&nbsp;&nbsp;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;function(json){ &nbsp;&nbsp;&nbsp;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}); &nbsp;</span></p><p><span> </span></p><p><span>$.ajax({ &nbsp;&nbsp;&nbsp;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;url: '', &nbsp;// <span>跨域</span><span>URL &nbsp;&nbsp;</span></span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type: 'GET', &nbsp;&nbsp;&nbsp;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dataType: 'jsonp', &nbsp;&nbsp;&nbsp;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jsonp: 'jsoncallback', //<span>默认</span><span>callback &nbsp;&nbsp;</span></span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data: mydata, //<span>请求数据</span><span> &nbsp;&nbsp;</span></span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;timeout: 5000, </span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;success: function (json) { //<span>客户端</span><span>jquery</span><span>预先定义好的</span><span>callback</span><span>函数，成功获取跨域服务器上的</span><span>json</span><span>数据后，会动态执行这个</span><span>callback</span><span>函数</span><span> &nbsp;&nbsp;&nbsp;</span></span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(json.actionErrors.length!=0){ &nbsp;&nbsp;&nbsp;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;alert(json.actionErrors); &nbsp;&nbsp;&nbsp;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} &nbsp;&nbsp;&nbsp;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}, &nbsp;&nbsp;&nbsp;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;complete: function(XMLHttpRequest, textStatus){ &nbsp;&nbsp;&nbsp;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}); &nbsp;</span></p><h1><span>3.<span>服务器端的跨域解决方案</span></span></h1><p><span>最新的W3C标准里是这么实现HTTP跨域请求的</span><a href="http://dev.w3.org/2006/waf/access-control"><span>Cross-Origin Resource Sharing</span></a><span>跨域的目标服务器要返回一系列的Headers，通过这些Headers来控制是否同意跨域。</span></p><p><span>Access-Control-Allow-Origin 这个 Header在W3C标准里用来检查该跨域请求是否可以被通过。</span></p><p><span>从 http://www.a.com/test.html 发起一个跨域请求，请求的地址为： </span><a href="http://www.b.com/test.php"><span>http://www.b.com/test.php</span></a><span> 如果 服务器B返回一个如下的header,Access-Control-Allow-Origin: http://www.a.com,那么，这个来自 http://www.a.com/test.html 的跨域请求就会被通过。在这个过程中， request 还会带上这个header,Access-Control-Allow-Origin 的值可以是通配符 *</span></p><p><span>如果是 * 的话，就可以接收来自任意source origin的请求。</span></p><p><span> </span></p><p><span>IE8 问题(</span><span>详情见情景4</span><span>)， 则是通过 XDomainRequest 来实现的这个跨域请求比如类似如下代码就可以实现了：</span></p><p><span>var request = new XDomainRequest();</span><span><br /></span><span>request.open(&quot;GET&quot;, xdomainurl);</span><span><br /></span><span>request.send();</span></p><p><span>也要求对方服务器返回这个头才行。</span></p><p><span>服务器端代码的操作示例:</span></p><p><span>1.</span><span>我们可以在java代码中加入 </span><span>response.setHeader(&quot;Access-Control-Allow-Origin&quot;, &quot;*&quot;);</span></p><p><span>2.html的，须要 &lt;meta http-equiv=&quot;Access-Control-Allow-Origin&quot; content=&quot;*&quot;&gt;</span></p><p><span>3.</span><span>“CrossOriginFilter”类，用于支持跨域的 JavaScript 请求，如果您的项目中要支持跨域的服务器推送，</span><span>可以</span><span>加入该配置。</span></p><p><span>package net.icbc.messager.web;</span></p><p><span> </span></p><p><span>import java.io.IOException;</span></p><p><span>import java.util.ArrayList;</span></p><p><span>import java.util.Arrays;</span></p><p><span>import java.util.List;</span></p><p><span>import javax.servlet.Filter;</span></p><p><span>import javax.servlet.FilterChain;</span></p><p><span>import javax.servlet.FilterConfig;</span></p><p><span>import javax.servlet.ServletException;</span></p><p><span>import javax.servlet.ServletRequest;</span></p><p><span>import javax.servlet.ServletResponse;</span></p><p><span>import javax.servlet.http.HttpServletRequest;</span></p><p><span>import javax.servlet.http.HttpServletResponse;</span></p><p><span> </span></p><p><span>import net.icbc.messager.web.servlet.TokenServlet;</span></p><p><span> </span></p><p><span>import org.apache.log4j.Logger;</span></p><p><span> </span></p><p><span> </span></p><p><span>/**</span></p><p><span> * &lt;p&gt;Implementation of the</span></p><p><span> * &lt;a href=&quot;http://dev.w3.org/2006/waf/access-control/&quot;&gt;cross-origin resource sharing&lt;/a&gt;.&lt;/p&gt;</span></p><p><span> * &lt;p&gt;A typical example is to use this filter to allow cross-domain</span></p><p><span> * &lt;a href=&quot;http://cometd.org&quot;&gt;cometd&lt;/a&gt; communication using the standard</span></p><p><span> * long polling transport instead of the JSONP transport (that is less</span></p><p><span> * efficient and less reactive to failures).&lt;/p&gt;</span></p><p><span> * &lt;p&gt;This filter allows the following configuration parameters:</span></p><p><span> * &lt;ul&gt;</span></p><p><span> * &lt;li&gt;&lt;b&gt;allowedOrigins&lt;/b&gt;, a comma separated list of origins that are</span></p><p><span> * allowed to access the resources. Default value is &lt;b&gt;*&lt;/b&gt;, meaning all</span></p><p><span> * origins&lt;/li&gt;</span></p><p><span> * &lt;li&gt;&lt;b&gt;allowedMethods&lt;/b&gt;, a comma separated list of HTTP methods that</span></p><p><span> * are allowed to be used when accessing the resources. Default value is</span></p><p><span> * &lt;b&gt;GET,POST&lt;/b&gt;&lt;/li&gt;</span></p><p><span> * &lt;li&gt;&lt;b&gt;allowedHeaders&lt;/b&gt;, a comma separated list of HTTP headers that</span></p><p><span> * are allowed to be specified when accessing the resources. Default value</span></p><p><span> * is &lt;b&gt;X-Requested-With&lt;/b&gt;&lt;/li&gt;</span></p><p><span> * &lt;li&gt;&lt;b&gt;preflightMaxAge&lt;/b&gt;, the number of seconds that preflight requests</span></p><p><span> * can be cached by the client. Default value is &lt;b&gt;1800&lt;/b&gt; seconds, or 30</span></p><p><span> * minutes&lt;/li&gt;</span></p><p><span> * &lt;li&gt;&lt;b&gt;allowCredentials&lt;/b&gt;, a boolean indicating if the resource allows</span></p><p><span> * requests with credentials. Default value is &lt;b&gt;false&lt;/b&gt;&lt;/li&gt;</span></p><p><span> * &lt;/ul&gt;&lt;/p&gt;</span></p><p><span> * &lt;p&gt;A typical configuration could be:</span></p><p><span> * &lt;pre&gt;</span></p><p><span> * &lt;web-app ...&gt;</span></p><p><span> * &nbsp;&nbsp;&nbsp;&nbsp;...</span></p><p><span> * &nbsp;&nbsp;&nbsp;&nbsp;&lt;filter&gt;</span></p><p><span> * &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;filter-name&gt;cross-origin&lt;/filter-name&gt;</span></p><p><span> * &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;filter-class&gt;org.eclipse.jetty.servlets.CrossOriginFilter&lt;/filter-class&gt;</span></p><p><span> * &nbsp;&nbsp;&nbsp;&nbsp;&lt;/filter&gt;</span></p><p><span> * &nbsp;&nbsp;&nbsp;&nbsp;&lt;filter-mapping&gt;</span></p><p><span> * &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;filter-name&gt;cross-origin&lt;/filter-name&gt;</span></p><p><span> * &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;url-pattern&gt;/cometd/*&lt;/url-pattern&gt;</span></p><p><span> * &nbsp;&nbsp;&nbsp;&nbsp;&lt;/filter-mapping&gt;</span></p><p><span> * &nbsp;&nbsp;&nbsp;&nbsp;...</span></p><p><span> * &lt;/web-app&gt;</span></p><p><span> * &lt;/pre&gt;&lt;/p&gt;</span></p><p><span> *</span></p><p><span> * @version $Revision$ $Date$</span></p><p><span> */</span></p><p><span>public class CrossOriginFilter implements Filter</span></p><p><span>{</span></p><p><span> &nbsp;&nbsp;</span></p><p><span>private static Logger log = Logger.getLogger(TokenServlet.class);</span></p><p><span>// Request headers</span></p><p><span> &nbsp;&nbsp;&nbsp;private static final String ORIGIN_HEADER = &quot;Origin&quot;;</span></p><p><span> &nbsp;&nbsp;&nbsp;private static final String ACCESS_CONTROL_REQUEST_METHOD_HEADER = &quot;Access-Control-Request-Method&quot;;</span></p><p><span> &nbsp;&nbsp;&nbsp;private static final String ACCESS_CONTROL_REQUEST_HEADERS_HEADER = &quot;Access-Control-Request-Headers&quot;;</span></p><p><span> &nbsp;&nbsp;&nbsp;// Response headers</span></p><p><span> &nbsp;&nbsp;&nbsp;private static final String ACCESS_CONTROL_ALLOW_ORIGIN_HEADER = &quot;Access-Control-Allow-Origin&quot;;</span></p><p><span> &nbsp;&nbsp;&nbsp;private static final String ACCESS_CONTROL_ALLOW_METHODS_HEADER = &quot;Access-Control-Allow-Methods&quot;;</span></p><p><span> &nbsp;&nbsp;&nbsp;private static final String ACCESS_CONTROL_ALLOW_HEADERS_HEADER = &quot;Access-Control-Allow-Headers&quot;;</span></p><p><span> &nbsp;&nbsp;&nbsp;private static final String ACCESS_CONTROL_MAX_AGE_HEADER = &quot;Access-Control-Max-Age&quot;;</span></p><p><span> &nbsp;&nbsp;&nbsp;private static final String ACCESS_CONTROL_ALLOW_CREDENTIALS_HEADER = &quot;Access-Control-Allow-Credentials&quot;;</span></p><p><span> &nbsp;&nbsp;&nbsp;// Implementation constants</span></p><p><span> &nbsp;&nbsp;&nbsp;private static final String ALLOWED_ORIGINS_PARAM = &quot;allowedOrigins&quot;;</span></p><p><span> &nbsp;&nbsp;&nbsp;private static final String ALLOWED_METHODS_PARAM = &quot;allowedMethods&quot;;</span></p><p><span> &nbsp;&nbsp;&nbsp;private static final String ALLOWED_HEADERS_PARAM = &quot;allowedHeaders&quot;;</span></p><p><span> &nbsp;&nbsp;&nbsp;private static final String PREFLIGHT_MAX_AGE_PARAM = &quot;preflightMaxAge&quot;;</span></p><p><span> &nbsp;&nbsp;&nbsp;private static final String ALLOWED_CREDENTIALS_PARAM = &quot;allowCredentials&quot;;</span></p><p><span> &nbsp;&nbsp;&nbsp;private static final String ANY_ORIGIN = &quot;*&quot;;</span></p><p><span> &nbsp;&nbsp;&nbsp;private static final List&lt;String&gt; SIMPLE_HTTP_METHODS = Arrays.asList(&quot;GET&quot;, &quot;POST&quot;, &quot;HEAD&quot;);</span></p><p><span> </span></p><p><span> &nbsp;&nbsp;&nbsp;private boolean anyOriginAllowed = false;</span></p><p><span> &nbsp;&nbsp;&nbsp;private List&lt;String&gt; allowedOrigins = new ArrayList&lt;String&gt;();</span></p><p><span> &nbsp;&nbsp;&nbsp;private List&lt;String&gt; allowedMethods = new ArrayList&lt;String&gt;();</span></p><p><span> &nbsp;&nbsp;&nbsp;private List&lt;String&gt; allowedHeaders = new ArrayList&lt;String&gt;();</span></p><p><span> &nbsp;&nbsp;&nbsp;private int preflightMaxAge = 0;</span></p><p><span> &nbsp;&nbsp;&nbsp;private boolean allowCredentials = false;</span></p><p><span> </span></p><p><span> &nbsp;&nbsp;&nbsp;public void init(FilterConfig config) throws ServletException</span></p><p><span> &nbsp;&nbsp;&nbsp;{</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String allowedOriginsConfig = config.getInitParameter(ALLOWED_ORIGINS_PARAM);</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (allowedOriginsConfig == null) allowedOriginsConfig = &quot;*&quot;;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String[] allowedOrigins = allowedOriginsConfig.split(&quot;,&quot;);</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (String allowedOrigin : allowedOrigins)</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allowedOrigin = allowedOrigin.trim();</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (allowedOrigin.length() &gt; 0)</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (ANY_ORIGIN.equals(allowedOrigin))</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;anyOriginAllowed = true;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.allowedOrigins.clear();</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.allowedOrigins.add(allowedOrigin);</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p><span> </span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String allowedMethodsConfig = config.getInitParameter(ALLOWED_METHODS_PARAM);</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (allowedMethodsConfig == null) allowedMethodsConfig = &quot;GET,POST&quot;;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allowedMethods.addAll(Arrays.asList(allowedMethodsConfig.split(&quot;,&quot;)));</span></p><p><span> </span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String allowedHeadersConfig = config.getInitParameter(ALLOWED_HEADERS_PARAM);</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (allowedHeadersConfig == null) allowedHeadersConfig = &quot;X-Requested-With,Content-Type,Accept,Origin&quot;;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allowedHeaders.addAll(Arrays.asList(allowedHeadersConfig.split(&quot;,&quot;)));</span></p><p><span> </span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String preflightMaxAgeConfig = config.getInitParameter(PREFLIGHT_MAX_AGE_PARAM);</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (preflightMaxAgeConfig == null) preflightMaxAgeConfig = &quot;1800&quot;; // Default is 30 minutes</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;preflightMaxAge = Integer.parseInt(preflightMaxAgeConfig);</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;catch (NumberFormatException x)</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.info(&quot;Cross-origin filter, could not parse '{}' parameter as integer: {}&quot;+ PREFLIGHT_MAX_AGE_PARAM+ preflightMaxAgeConfig);</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p><span> </span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String allowedCredentialsConfig = config.getInitParameter(ALLOWED_CREDENTIALS_PARAM);</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (allowedCredentialsConfig == null) allowedCredentialsConfig = &quot;false&quot;;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allowCredentials = Boolean.parseBoolean(allowedCredentialsConfig);</span></p><p><span> </span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.debug(&quot;Cross-origin filter configuration: &quot; +</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ALLOWED_ORIGINS_PARAM + &quot; = &quot; + allowedOriginsConfig + &quot;, &quot; +</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ALLOWED_METHODS_PARAM + &quot; = &quot; + allowedMethodsConfig + &quot;, &quot; +</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ALLOWED_HEADERS_PARAM + &quot; = &quot; + allowedHeadersConfig + &quot;, &quot; +</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PREFLIGHT_MAX_AGE_PARAM + &quot; = &quot; + preflightMaxAgeConfig + &quot;, &quot; +</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ALLOWED_CREDENTIALS_PARAM + &quot; = &quot; + allowedCredentialsConfig);</span></p><p><span> &nbsp;&nbsp;&nbsp;}</span></p><p><span> </span></p><p><span> &nbsp;&nbsp;&nbsp;public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException</span></p><p><span> &nbsp;&nbsp;&nbsp;{</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;handle((HttpServletRequest)request, (HttpServletResponse)response, chain);</span></p><p><span> &nbsp;&nbsp;&nbsp;}</span></p><p><span> </span></p><p><span> &nbsp;&nbsp;&nbsp;private void handle(HttpServletRequest request, HttpServletResponse response, FilterChain chain) throws IOException, ServletException</span></p><p><span> &nbsp;&nbsp;&nbsp;{</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String origin = request.getHeader(ORIGIN_HEADER);</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Is it a cross origin request ?</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (origin != null &amp;&amp; isEnabled(request))</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (originMatches(origin))</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (isSimpleRequest(request))</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.debug(&quot;Cross-origin request to {} is a simple cross-origin request&quot;+ request.getRequestURI());</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;handleSimpleResponse(request, response, origin);</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.debug(&quot;Cross-origin request to {} is a preflight cross-origin request&quot; +request.getRequestURI());</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;handlePreflightResponse(request, response, origin);</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.debug(&quot;Cross-origin request to &quot; + request.getRequestURI() + &quot; with origin &quot; + origin + &quot; does not match allowed origins &quot; + allowedOrigins);</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p><span> </span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chain.doFilter(request, response);</span></p><p><span> &nbsp;&nbsp;&nbsp;}</span></p><p><span> </span></p><p><span> &nbsp;&nbsp;&nbsp;protected boolean isEnabled(HttpServletRequest request)</span></p><p><span> &nbsp;&nbsp;&nbsp;{</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// WebSocket clients such as Chrome 5 implement a version of the WebSocket</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// protocol that does not accept extra response headers on the upgrade response</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (&quot;Upgrade&quot;.equalsIgnoreCase(request.getHeader(&quot;Connection&quot;)) &amp;&amp;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;WebSocket&quot;.equalsIgnoreCase(request.getHeader(&quot;Upgrade&quot;)))</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return false;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return true;</span></p><p><span> &nbsp;&nbsp;&nbsp;}</span></p><p><span> </span></p><p><span> &nbsp;&nbsp;&nbsp;private boolean originMatches(String origin)</span></p><p><span> &nbsp;&nbsp;&nbsp;{</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (anyOriginAllowed) return true;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (String allowedOrigin : allowedOrigins)</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (allowedOrigin.equals(origin)) return true;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return false;</span></p><p><span> &nbsp;&nbsp;&nbsp;}</span></p><p><span> </span></p><p><span> &nbsp;&nbsp;&nbsp;private boolean isSimpleRequest(HttpServletRequest request)</span></p><p><span> &nbsp;&nbsp;&nbsp;{</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String method = request.getMethod();</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (SIMPLE_HTTP_METHODS.contains(method))</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// TODO: implement better section 6.1</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Section 6.1 says that for a request to be simple, custom request headers must be simple.</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Here for simplicity I just check if there is a Access-Control-Request-Method header,</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// which is required for preflight requests</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return request.getHeader(ACCESS_CONTROL_REQUEST_METHOD_HEADER) == null;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return false;</span></p><p><span> &nbsp;&nbsp;&nbsp;}</span></p><p><span> </span></p><p><span> &nbsp;&nbsp;&nbsp;private void handleSimpleResponse(HttpServletRequest request, HttpServletResponse response, String origin)</span></p><p><span> &nbsp;&nbsp;&nbsp;{</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.setHeader(ACCESS_CONTROL_ALLOW_ORIGIN_HEADER, origin);</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (allowCredentials) response.setHeader(ACCESS_CONTROL_ALLOW_CREDENTIALS_HEADER, &quot;true&quot;);</span></p><p><span> &nbsp;&nbsp;&nbsp;}</span></p><p><span> </span></p><p><span> &nbsp;&nbsp;&nbsp;private void handlePreflightResponse(HttpServletRequest request, HttpServletResponse response, String origin)</span></p><p><span> &nbsp;&nbsp;&nbsp;{</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Implementation of section 5.2</span></p><p><span> </span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// 5.2.3 and 5.2.5</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean methodAllowed = isMethodAllowed(request);</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (!methodAllowed) return;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// 5.2.4 and 5.2.6</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean headersAllowed = areHeadersAllowed(request);</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (!headersAllowed) return;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// 5.2.7</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.setHeader(ACCESS_CONTROL_ALLOW_ORIGIN_HEADER, origin);</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (allowCredentials) response.setHeader(ACCESS_CONTROL_ALLOW_CREDENTIALS_HEADER, &quot;true&quot;);</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// 5.2.8</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (preflightMaxAge &gt; 0) response.setHeader(ACCESS_CONTROL_MAX_AGE_HEADER, String.valueOf(preflightMaxAge));</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// 5.2.9</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.setHeader(ACCESS_CONTROL_ALLOW_METHODS_HEADER, commify(allowedMethods));</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// 5.2.10</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;response.setHeader(ACCESS_CONTROL_ALLOW_HEADERS_HEADER, commify(allowedHeaders));</span></p><p><span> &nbsp;&nbsp;&nbsp;}</span></p><p><span> </span></p><p><span> &nbsp;&nbsp;&nbsp;private boolean isMethodAllowed(HttpServletRequest request)</span></p><p><span> &nbsp;&nbsp;&nbsp;{</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String accessControlRequestMethod = request.getHeader(ACCESS_CONTROL_REQUEST_METHOD_HEADER);</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.debug(&quot;{} is {}&quot;+ ACCESS_CONTROL_REQUEST_METHOD_HEADER+ accessControlRequestMethod);</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean result = false;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (accessControlRequestMethod != null)</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result = allowedMethods.contains(accessControlRequestMethod);</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.debug(&quot;Method {} is&quot; + (result ? &quot;&quot; : &quot; not&quot;) + &quot; among allowed methods {}&quot;+accessControlRequestMethod+allowedMethods);</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return result;</span></p><p><span> &nbsp;&nbsp;&nbsp;}</span></p><p><span> </span></p><p><span> &nbsp;&nbsp;&nbsp;private boolean areHeadersAllowed(HttpServletRequest request)</span></p><p><span> &nbsp;&nbsp;&nbsp;{</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String accessControlRequestHeaders = request.getHeader(ACCESS_CONTROL_REQUEST_HEADERS_HEADER);</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.debug(&quot;{} is {}&quot;+ ACCESS_CONTROL_REQUEST_HEADERS_HEADER+ &nbsp;accessControlRequestHeaders);</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean result = true;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (accessControlRequestHeaders != null)</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String[] headers = accessControlRequestHeaders.split(&quot;,&quot;);</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (String header : headers)</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean headerAllowed = false;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (String allowedHeader : allowedHeaders)</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (header.trim().equalsIgnoreCase(allowedHeader.trim()))</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;headerAllowed = true;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (!headerAllowed)</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result = false;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log.debug(&quot;Headers [{}] are&quot; + (result ? &quot;&quot; : &quot; not&quot;) + &quot; among allowed headers {}&quot;+accessControlRequestHeaders+allowedHeaders);</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return result;</span></p><p><span> &nbsp;&nbsp;&nbsp;}</span></p><p><span> </span></p><p><span> &nbsp;&nbsp;&nbsp;private String commify(List&lt;String&gt; strings)</span></p><p><span> &nbsp;&nbsp;&nbsp;{</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StringBuilder builder = new StringBuilder();</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for (int i = 0; i &lt; strings.size(); ++i)</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (i &gt; 0) builder.append(&quot;,&quot;);</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String string = strings.get(i);</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;builder.append(string);</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return builder.toString();</span></p><p><span> &nbsp;&nbsp;&nbsp;}</span></p><p><span> </span></p><p><span> &nbsp;&nbsp;&nbsp;public void destroy()</span></p><p><span> &nbsp;&nbsp;&nbsp;{</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;anyOriginAllowed = false;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allowedOrigins.clear();</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allowedMethods.clear();</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allowedHeaders.clear();</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;preflightMaxAge = 0;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allowCredentials = false;</span></p><p><span> &nbsp;&nbsp;&nbsp;}</span></p><p><span>}</span></p><p><span> </span></p><p><span>F</span><span>ileter<span>配置信息</span><span>:</span></span></p><p><span>&lt;filter&gt;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;filter-name&gt;cross-origin&lt;/filter-name&gt;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;filter-class&gt;net.icbc.messager.web.CrossOriginFilter&lt;/filter-class&gt;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&lt;/filter&gt;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&lt;filter-mapping&gt;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;filter-name&gt;cross-origin&lt;/filter-name&gt;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;url-pattern&gt;/*&lt;/url-pattern&gt;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&lt;/filter-mapping&gt;</span></p><p><span> </span></p><h1><span>4.IE8<span>下的跨域问题</span></span></h1><p><span>情景4需在情景3的基础上进行,仅仅进行情景3的设置,是在IE8下行不通的.</span></p><p><span>通过使用 Internet Explorer 8 中的跨域请求（缩写为“XDR”），开发人员可以创建跨网站数据聚合方案。 这个名为 </span><a href="http://msdn.microsoft.com/library/cc287985.aspx"><span>XDomainRequest</span></a><span> 的请求与 </span><a href="http://msdn.microsoft.com/library/ms535157.aspx"><span>XMLHttpRequest</span></a><span> 对象类似，但编程模型更加简单，它可以提供一种最简单的方式来向支持 XDR 的第三方站点发出匿名请求，并选择使这些站点的数据可跨域使用。 只需三行代码即可生成基本的跨站点请求。 这将确保针对公共站点（例如，博客或其他社交网络应用程序）的数据聚合简单、安全和快速。</span></p><p><span> </span></p><p><span>下面的 JavaScript 代码介绍 XDomainRequest 对象及其事件、属性和方法。 </span><a href="http://msdn.microsoft.com/library/cc287985.aspx"><span>XDomainRequest</span></a><span> 参考页提供了比此处更为详细的信息。</span></p><p><span>// Creates a new XDR object.</span></p><p><span>xdr = new XDomainRequest(); &nbsp;</span></p><p><span> </span></p><p><span>// Indicates there is an error and the request cannot be completed. </span></p><p><span>xdr.onerror = alert_error;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p><span>// The request has reached its timeout. </span></p><p><span>xdr.ontimeout = alert_timeout;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p><span>// The object has started returning data.</span></p><p><span>xdr.onprogress = alert_progress;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p><span>// The object is complete. </span></p><p><span>xdr.onload = alert_loaded;</span></p><p><span> </span></p><p><span>// Sets the timeout interval.</span></p><p><span>xdr.timeout = timeout;</span></p><p><span> </span></p><p><span>// Gets the content-type header in the request.</span></p><p><span>var content_type = xdr.contentType;</span></p><p><span> </span></p><p><span>// Gets the body of the response.</span></p><p><span>var response = xdr.responseText;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p><span>// Creates a connection with a domain's server. </span></p><p><span>xdr.open(&quot;get&quot;, url);</span></p><p><span> </span></p><p><span>// Transmits a data string to the server. </span></p><p><span>xdr.send();</span></p><p><span> </span></p><p><span>// Terminates a pending send.</span></p><p><span>xdr.abort();</span></p><p><span> </span></p><p><span>附:IE8下的跨域js的兼容设置,实现XDR对象到XHR对象的转换 </span><span>ieXDRToXHR.js</span><span> (注此js会对jQuery形成干扰)</span></p><p><span> </span></p><p><span>if (window.XDomainRequest) {</span></p><p><span> &nbsp;&nbsp;&nbsp;window.ieXDRToXHR = function(window) {</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;use strict&quot;;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var XHR = window.XMLHttpRequest;</span></p><p><span> </span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;window.XMLHttpRequest = function() {</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.onreadystatechange = Object;</span></p><p><span> </span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.xhr = null;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.xdr = null;</span></p><p><span> </span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.readyState = 0;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.status = '';</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.statusText = null;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.responseText = null;</span></p><p><span> </span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.getResponseHeader = null;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.getAllResponseHeaders = null;</span></p><p><span> </span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.setRequestHeader = null;</span></p><p><span> </span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.abort = null;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.send = null;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.isxdr = false;</span></p><p><span> </span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// static binding</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var self = this;</span></p><p><span> </span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.xdrLoadedBinded = function() {</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.xdrLoaded();</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.xdrErrorBinded = function() {</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.xdrError();</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.xdrProgressBinded = function() {</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.xdrProgress();</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.xhrReadyStateChangedBinded = function() {</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.xhrReadyStateChanged();</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</span></p><p><span> </span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;XMLHttpRequest.prototype.open = function(method, url, asynch, user, pwd) {</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//improve CORS deteciton (chat.example.net exemple.net), remove hardcoded http-bind</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var parser = document.createElement('a');</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parser.href = url;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (parser.hostname!=document.domain) {</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (this.xdr === null){</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.xdr = new window.XDomainRequest();</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p><span> </span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.isxdr = true;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.setXDRActive();</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.xdr.open(method, url);</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (this.xhr === null){</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.xhr = new XHR();</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p><span> </span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.isxdr = false;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.setXHRActive();</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.xhr.open(method, url, asynch, user, pwd);</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</span></p><p><span> </span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;XMLHttpRequest.prototype.xdrGetResponseHeader = function(name) {</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (name === 'Content-Type' &amp;&amp; this.xdr.contentType &gt; ''){</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return this.xdr.contentType;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p><span> </span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return '';</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;XMLHttpRequest.prototype.xdrGetAllResponseHeaders = function() {</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return (this.xdr.contentType &gt; '') ? 'Content-Type: ' + this.xdr.contentType : '';</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;XMLHttpRequest.prototype.xdrSetRequestHeader = function(name, value) {</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//throw new Error('Request headers not supported');</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;XMLHttpRequest.prototype.xdrLoaded = function() {</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (this.onreadystatechange !== null) {</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.readyState = 4;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.status = 200;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.statusText = 'OK';</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.responseText = this.xdr.responseText;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (window.ActiveXObject){</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var doc = new ActiveXObject('Microsoft.XMLDOM');</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;doc.async='false';</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;doc.loadXML(this.responseText);</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.responseXML = doc;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.onreadystatechange();</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;XMLHttpRequest.prototype.xdrError = function() {</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (this.onreadystatechange !== null) {</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.readyState = 4;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.status = 0;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.statusText = '';</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// ???</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.responseText = '';</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.onreadystatechange();</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;XMLHttpRequest.prototype.xdrProgress = function() {</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (this.onreadystatechange !== null &amp;&amp; this.status !== 3) {</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.readyState = 3;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.status = 3;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.statusText = '';</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.onreadystatechange();</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;XMLHttpRequest.prototype.finalXDRRequest = function() {</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var xdr = this.xdr;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete xdr.onload;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete xdr.onerror;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete xdr.onprogress;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;XMLHttpRequest.prototype.sendXDR = function(data) {</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var xdr = this.xdr;</span></p><p><span> </span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xdr.onload = this.xdrLoadedBinded;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xdr.onerror = this.xdr.ontimeout = this.xdrErrorBinded;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xdr.onprogress = this.xdrProgressBinded;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.responseText = null;</span></p><p><span> </span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.xdr.send(data);</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;XMLHttpRequest.prototype.abortXDR = function() {</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.finalXDRRequest();</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.xdr.abort();</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;XMLHttpRequest.prototype.setXDRActive = function() {</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.send = this.sendXDR;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.abort = this.abortXDR;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.getResponseHeader = this.xdrGetResponseHeader;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.getAllResponseHeaders = this.xdrGetAllResponseHeaders;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.setRequestHeader = this.xdrSetRequestHeader;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</span></p><p><span> </span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;XMLHttpRequest.prototype.xhrGetResponseHeader = function(name) {</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return this.xhr.getResponseHeader(name);</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;XMLHttpRequest.prototype.xhrGetAllResponseHeaders = function() {</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return this.xhr.getAllResponseHeaders();</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;XMLHttpRequest.prototype.xhrSetRequestHeader = function(name, value) {</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return this.xhr.setRequestHeader(name, value);</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;XMLHttpRequest.prototype.xhrReadyStateChanged = function() {</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (this.onreadystatechange !== null &amp;&amp; this.readyState !== this.xhr.readyState) {</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var xhr = this.xhr;</span></p><p><span> </span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.readyState = xhr.readyState;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (this.readyState === 4) {</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.status = xhr.status;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.statusText = xhr.statusText;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.responseText = xhr.responseText;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.responseXML = xhr.responseXML;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p><span> </span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.onreadystatechange();</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;XMLHttpRequest.prototype.finalXHRRequest = function() {</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete this.xhr.onreadystatechange;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;XMLHttpRequest.prototype.abortXHR = function() {</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.finalXHRRequest();</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.xhr.abort();</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;XMLHttpRequest.prototype.sendXHR = function(data) {</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.xhr.onreadystatechange = this.xhrReadyStateChangedBinded;</span></p><p><span> </span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.xhr.send(data);</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;XMLHttpRequest.prototype.setXHRActive = function() {</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.send = this.sendXHR;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.abort = this.abortXHR;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.getResponseHeader = this.xhrGetResponseHeader;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.getAllResponseHeaders = this.xhrGetAllResponseHeaders;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.setRequestHeader = this.xhrSetRequestHeader;</span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</span></p><p><span> </span></p><p><span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;window.ieXDRToXHR = undefined;</span></p><p><span> &nbsp;&nbsp;&nbsp;};</span></p><p><span> &nbsp;&nbsp;&nbsp;window.ieXDRToXHR(window);</span></p><p><span>}</span></p><p><span> </span></p><h1><br /></h1><p></p></body></html>
